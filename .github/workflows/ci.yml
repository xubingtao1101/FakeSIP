name: CI

on:
  push:
  pull_request:
  workflow_dispatch:
  workflow_call:
    inputs:
      version:
        description: Version Number
        type: string
        required: false

jobs:
  Lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Install clang-format
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format
      - name: Run clang-format
        run: |
          clang-format --dry-run --Werror src/*.c include/*.h

  Build:
    name: Build
    runs-on: ubuntu-latest
    env:
      cross_dir: /opt/x-tools
    strategy:
      matrix:
        include:
          - name: x86_64
            triplet: x86_64-unknown-linux-musl
            sha256: a896bad67a4dae7cd7baece62d537fda07f8c74e65fee1b450a691b83e151a9c
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Set up toolchain for ${{ matrix.name }}
        run: |
          CROSS_TOOLCHAIN_URL="https://github.com/cross-tools/musl-cross/releases/download/20250520/${{ matrix.triplet }}.tar.xz"

          sudo mkdir -m 777 -p "${{ env.cross_dir }}"
          env \
              CROSS_TRIPLET="${{ matrix.triplet }}" \
              CROSS_TOOLCHAIN_URL="$CROSS_TOOLCHAIN_URL" \
              CROSS_TOOLCHAIN_SHA256="${{ matrix.sha256 }}" \
              CROSS_DIR="${{ env.cross_dir }}" \
              .github/workflows/scripts/cross-setup.sh
      - name: Build for ${{ matrix.name }}
        run: |
          CROSS_PREFIX="${{ env.cross_dir }}/${{ matrix.triplet }}/bin/${{ matrix.triplet }}-"
          VERSION="${{ inputs.version }}"

          if [ -n "$VERSION" ]; then
              make -j$(nproc) CFLAGS="-Werror" STATIC=1 CROSS_PREFIX="$CROSS_PREFIX" VERSION="$VERSION"
          else
              make -j$(nproc) CFLAGS="-Werror" STATIC=1 CROSS_PREFIX="$CROSS_PREFIX"
          fi
      - name: Upload ${{ matrix.name }}
        uses: actions/upload-artifact@v4
        with:
          name: fakesip-linux-${{ matrix.name }}
          path: build/fakesip
          if-no-files-found: error
